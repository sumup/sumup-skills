name: Validate Skills

on:
  pull_request:
    paths:
      - "skills/**"
      - ".github/workflows/validate-skills.yml"
  push:
    branches:
      - main
    paths:
      - "skills/**"
      - ".github/workflows/validate-skills.yml"
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.x"

      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv

      - name: Install Claude Code
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Validate Claude plugin
        run: |
          set -euo pipefail
          claude plugin validate .

      - name: Validate all skills
        run: |
          set -euo pipefail
          found=0
          while IFS= read -r skill_dir; do
            if [ ! -f "${skill_dir}/SKILL.md" ]; then
              continue
            fi
            found=1
            echo "Validating ${skill_dir}"
            uvx --from "git+https://github.com/agentskills/agentskills.git#subdirectory=skills-ref" \
              skills-ref validate "${skill_dir}/"
          done < <(find skills -mindepth 1 -maxdepth 1 -type d | sort)

          if [ "${found}" -eq 0 ]; then
            echo "No skills found under skills/"
            exit 1
          fi
